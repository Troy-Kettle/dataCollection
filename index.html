<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vital Signs Concern Levels</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- CSS Styles -->
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f4f8;
            color: #333;
            padding: 20px;
            margin: 0;
        }
        h1, h2 {
            text-align: center;
            color: #2c3e50;
        }
        .vital-sign {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .vital-sign h3 {
            margin-top: 0;
            color: #3498db;
        }
        .scale-container {
            position: relative;
            margin: 40px 0;
        }
        .scale {
            position: relative;
            height: 50px;
        }
        .track {
            position: absolute;
            width: 100%;
            height: 10px;
            background: #d3d3d3;
            border-radius: 5px;
            top: 20px;
        }
        .range {
            position: absolute;
            height: 10px;
            top: 20px;
            border-radius: 5px;
        }
        .thumb {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #3498db;
            border-radius: 50%;
            top: 15px;
            transform: translateX(-50%);
            cursor: pointer;
        }
        .labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            margin-top: 10px;
        }
        .concern-levels {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .concern-level {
            flex: 1;
            text-align: center;
            padding: 5px 0;
            color: #fff;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8em;
        }
        .no-concern { background-color: #2ecc71; }
        .mild-concern { background-color: #f1c40f; }
        .moderate-concern { background-color: #f39c12; }
        .severe-concern { background-color: #e74c3c; }
        /* Submit Button */
        #submitButton {
            display: block;
            margin: 40px auto;
            padding: 15px 30px;
            font-size: 1em;
            color: #fff;
            background-color: #3498db;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #submitButton:hover {
            background-color: #2980b9;
        }
        /* Table Styles */
        .threshold-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .threshold-table th, .threshold-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        .threshold-table th {
            background-color: #f9f9f9;
        }
        /* Part 2 Styles */
        #part2Container {
            margin-top: 50px;
        }
        .question-set {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .question-set h3 {
            margin-top: 0;
            color: #3498db;
        }
        .question {
            margin-bottom: 15px;
        }
        .question label {
            display: block;
            margin-bottom: 5px;
        }
        .question select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Vital Signs Concern Level Boundaries</h1>
    <div id="vitalSignsContainer"></div>

    <!-- Part 2: Further Interpretation of Vital Signs -->
    <h2>Part 2: Further Interpretation of Vital Signs</h2>
    <div id="part2Container"></div>

    <button id="submitButton">Submit</button>

    <script>
        const vitalSignsData = [
            {
                name: "Heart Rate",
                unit: "min⁻¹",
                min: 20,
                max: 250,
                hasBothDirections: true
            },
            {
                name: "Systolic Blood Pressure",
                unit: "mmHg",
                min: 40,
                max: 250,
                hasBothDirections: true
            },
            {
                name: "Respiratory Rate",
                unit: "min⁻¹",
                min: 1,
                max: 60,
                hasBothDirections: true
            },
            {
                name: "Temperature",
                unit: "℃",
                min: 32.0,
                max: 42.0,
                hasBothDirections: true
            },
            {
                name: "Oxygen Saturation",
                unit: "%",
                min: 50,
                max: 100,
                hasBothDirections: false,
                reverseScale: true
            },
            {
                name: "Inspired Oxygen",
                unit: "L/min",
                min: 0,
                max: 15,
                hasBothDirections: false
            },
            {
                name: "Inspired Oxygen",
                unit: "%",
                min: 21,
                max: 100,
                hasBothDirections: false
            }
        ];

        const concernLevels = [
            { label: 'Severe Concern', class: 'severe-concern' },
            { label: 'Moderate Concern', class: 'moderate-concern' },
            { label: 'Mild Concern', class: 'mild-concern' },
            { label: 'No Concern', class: 'no-concern' },
            { label: 'Mild Concern', class: 'mild-concern' },
            { label: 'Moderate Concern', class: 'moderate-concern' },
            { label: 'Severe Concern', class: 'severe-concern' }
        ];

        const part2Questions = [
            "What is normal for that individual patient.",
            "Whether the general trend is worsening or improving",
            "Whether the abnormality has developed suddenly or gradually",
            "Recent abnormal values, even if they have now gone back to normal",
            "Fluctuating or variable values"
        ];

        const frequencyOptions = ["never", "rarely", "sometimes", "often", "always"];

        function createVitalSignElement(vitalSign) {
            const container = document.createElement('div');
            container.className = 'vital-sign';

            const title = document.createElement('h3');
            title.textContent = `${vitalSign.name} (${vitalSign.unit})`;
            container.appendChild(title);

            const scaleContainer = document.createElement('div');
            scaleContainer.className = 'scale-container';
            container.appendChild(scaleContainer);

            const track = document.createElement('div');
            track.className = 'track';
            scaleContainer.appendChild(track);

            const ranges = [];
            const thumbs = [];

            const defaultValues = getDefaultValues(vitalSign);

            defaultValues.forEach((value, index) => {
                if (index < defaultValues.length - 1) {
                    const range = document.createElement('div');
                    range.className = 'range';
                    range.style.backgroundColor = getConcernColor(index, vitalSign);
                    scaleContainer.appendChild(range);
                    ranges.push(range);
                }

                const thumb = document.createElement('div');
                thumb.className = 'thumb';
                thumb.dataset.index = index;
                thumb.setAttribute('draggable', true);
                scaleContainer.appendChild(thumb);
                thumbs.push(thumb);

                thumb.addEventListener('dragstart', e => e.preventDefault());
            });

            const labels = document.createElement('div');
            labels.className = 'labels';
            const steps = 5;
            for (let i = 0; i <= steps; i++) {
                const label = document.createElement('span');
                const value = vitalSign.min + (vitalSign.max - vitalSign.min) * (i / steps);
                label.textContent = vitalSign.unit === '℃' ? value.toFixed(1) : Math.round(value);
                labels.appendChild(label);
            }
            scaleContainer.appendChild(labels);

            const concernLevelsContainer = document.createElement('div');
            concernLevelsContainer.className = 'concern-levels';
            const levels = getConcernLevels(vitalSign);
            levels.forEach(level => {
                const levelDiv = document.createElement('div');
                levelDiv.className = `concern-level ${level.class}`;
                levelDiv.textContent = level.label;
                concernLevelsContainer.appendChild(levelDiv);
            });
            container.appendChild(concernLevelsContainer);

            // Create table to display thresholds
            const thresholdTable = document.createElement('table');
            thresholdTable.className = 'threshold-table';

            const tableHeader = document.createElement('thead');
            const headerRow = document.createElement('tr');

            const thresholdHeader = document.createElement('th');
            thresholdHeader.textContent = 'Concern Level';

            const valueHeader = document.createElement('th');
            valueHeader.textContent = 'Threshold Value';

            headerRow.appendChild(thresholdHeader);
            headerRow.appendChild(valueHeader);
            tableHeader.appendChild(headerRow);
            thresholdTable.appendChild(tableHeader);

            const tableBody = document.createElement('tbody');
            thresholdTable.appendChild(tableBody);

            container.appendChild(thresholdTable);

            // Initialize positions
            updatePositions();

            // Event listeners
            thumbs.forEach((thumb, index) => {
                let isDragging = false;
                thumb.addEventListener('mousedown', e => {
                    isDragging = true;
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                    e.preventDefault();
                });

                function onMouseMove(e) {
                    if (!isDragging) return;
                    const rect = track.getBoundingClientRect();
                    let offsetX = e.clientX - rect.left;
                    offsetX = Math.max(0, Math.min(offsetX, rect.width));
                    const percent = offsetX / rect.width;
                    const value = vitalSign.min + percent * (vitalSign.max - vitalSign.min);
                    defaultValues[index] = value;
                    enforceBoundaries(index);
                    updatePositions();
                }

                function onMouseUp() {
                    isDragging = false;
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }
            });

            function enforceBoundaries(index) {
                if (vitalSign.hasBothDirections) {
                    if (index > 0 && defaultValues[index] < defaultValues[index - 1]) {
                        defaultValues[index] = defaultValues[index - 1];
                    }
                    if (index < defaultValues.length - 1 && defaultValues[index] > defaultValues[index + 1]) {
                        defaultValues[index] = defaultValues[index + 1];
                    }
                } else {
                    if (vitalSign.reverseScale) {
                        if (index > 0 && defaultValues[index] > defaultValues[index - 1]) {
                            defaultValues[index] = defaultValues[index - 1];
                        }
                        if (index < defaultValues.length - 1 && defaultValues[index] < defaultValues[index + 1]) {
                            defaultValues[index] = defaultValues[index + 1];
                        }
                    } else {
                        if (index > 0 && defaultValues[index] < defaultValues[index - 1]) {
                            defaultValues[index] = defaultValues[index - 1];
                        }
                        if (index < defaultValues.length - 1 && defaultValues[index] > defaultValues[index + 1]) {
                            defaultValues[index] = defaultValues[index + 1];
                        }
                    }
                }
            }

            function updatePositions() {
                const min = vitalSign.min;
                const max = vitalSign.max;
                defaultValues.forEach((value, index) => {
                    const percent = ((value - min) / (max - min)) * 100;
                    thumbs[index].style.left = `${percent}%`;
                });

                ranges.forEach((range, index) => {
                    const start = defaultValues[index];
                    const end = defaultValues[index + 1];
                    const startPercent = ((start - min) / (max - min)) * 100;
                    const endPercent = ((end - min) / (max - min)) * 100;
                    range.style.left = `${startPercent}%`;
                    range.style.width = `${endPercent - startPercent}%`;
                });

                // Update the table
                updateThresholdTable();
            }

            function updateThresholdTable() {
                // Clear existing table rows
                tableBody.innerHTML = '';

                // Get the concern levels
                const levels = getConcernLevels(vitalSign);

                // For each threshold, create a table row
                for (let i = 1; i < defaultValues.length - 1; i++) {
                    const row = document.createElement('tr');
                    const thresholdCell = document.createElement('td');
                    thresholdCell.textContent = levels[i - 1].label;
                    const valueCell = document.createElement('td');
                    valueCell.textContent = formatValue(defaultValues[i], vitalSign);
                    row.appendChild(thresholdCell);
                    row.appendChild(valueCell);
                    tableBody.appendChild(row);
                }
            }

            function formatValue(value, vitalSign) {
                if (vitalSign.unit === '℃') {
                    return value.toFixed(1);
                } else if (vitalSign.unit === 'L/min') {
                    return value.toFixed(1);
                } else {
                    return Math.round(value);
                }
            }

            vitalSign.getValues = function() {
                return defaultValues.map(value => formatValue(value, vitalSign));
            };

            return container;
        }

        function getDefaultValues(vitalSign) {
            const { min, max } = vitalSign;
            if (vitalSign.hasBothDirections) {
                return [
                    min,
                    min + (max - min) * 0.1,
                    min + (max - min) * 0.2,
                    min + (max - min) * 0.4,
                    min + (max - min) * 0.6,
                    min + (max - min) * 0.8,
                    min + (max - min) * 0.9,
                    max
                ];
            } else {
                if (vitalSign.reverseScale) {
                    return [
                        max,
                        max - (max - min) * 0.2,
                        max - (max - min) * 0.4,
                        min
                    ];
                } else {
                    return [
                        min,
                        min + (max - min) * 0.2,
                        min + (max - min) * 0.4,
                        max
                    ];
                }
            }
        }

        function getConcernLevels(vitalSign) {
            if (vitalSign.hasBothDirections) {
                return concernLevels;
            } else {
                if (vitalSign.reverseScale) {
                    return [
                        { label: 'Severe Concern', class: 'severe-concern' },
                        { label: 'Moderate Concern', class: 'moderate-concern' },
                        { label: 'Mild Concern', class: 'mild-concern' },
                        { label: 'No Concern', class: 'no-concern' }
                    ];
                } else {
                    return [
                        { label: 'No Concern', class: 'no-concern' },
                        { label: 'Mild Concern', class: 'mild-concern' },
                        { label: 'Moderate Concern', class: 'moderate-concern' },
                        { label: 'Severe Concern', class: 'severe-concern' }
                    ];
                }
            }
        }

        function getConcernColor(index, vitalSign) {
            const levels = getConcernLevels(vitalSign);
            return levels[index].class.includes('no-concern') ? '#2ecc71' :
                   levels[index].class.includes('mild-concern') ? '#f1c40f' :
                   levels[index].class.includes('moderate-concern') ? '#f39c12' :
                   '#e74c3c';
        }

        function collectData() {
            const data = [];
            vitalSignsData.forEach(vitalSign => {
                const values = vitalSign.getValues();
                data.push({
                    'Vital Sign': vitalSign.name,
                    'Unit': vitalSign.unit,
                    'Values': values.join(';')
                });
            });

            // Collect responses from Part 2
            const part2Responses = [];
            vitalSignsData.forEach(vitalSign => {
                const response = {
                    'Vital Sign': vitalSign.name,
                    'Questions': {}
                };
                part2Questions.forEach(question => {
                    const select = document.querySelector(`select[name="${vitalSign.name}-${question}"]`);
                    response['Questions'][question] = select.value;
                });
                part2Responses.push(response);
            });

            return { thresholds: data, part2Responses: part2Responses };
        }

        function downloadCSV(data) {
            let csvContent = 'data:text/csv;charset=utf-8,';
            csvContent += 'Vital Sign,Unit,Thresholds\n';
            data.thresholds.forEach(row => {
                csvContent += `${row['Vital Sign']},${row['Unit']},${row['Values']}\n`;
            });

            // Add Part 2 responses
            csvContent += '\nPart 2 Responses\n';
            data.part2Responses.forEach(response => {
                csvContent += `Vital Sign: ${response['Vital Sign']}\n`;
                Object.keys(response['Questions']).forEach(question => {
                    csvContent += `${question},${response['Questions'][question]}\n`;
                });
                csvContent += '\n';
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'vital_signs_data.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        const vitalSignsContainer = document.getElementById('vitalSignsContainer');

        vitalSignsData.forEach(vitalSign => {
            const vitalSignElement = createVitalSignElement(vitalSign);
            vitalSignsContainer.appendChild(vitalSignElement);
        });

        // Create Part 2 Section
        const part2Container = document.getElementById('part2Container');

        vitalSignsData.forEach(vitalSign => {
            if (vitalSign.name === "Inspired Oxygen" && vitalSign.unit === "%") {
                // Skip duplicate Inspired Oxygen entry
                return;
            }

            const questionSet = document.createElement('div');
            questionSet.className = 'question-set';

            const title = document.createElement('h3');
            title.textContent = `When interpreting ${vitalSign.name}, how often do you take into account:`;
            questionSet.appendChild(title);

            part2Questions.forEach(questionText => {
                const question = document.createElement('div');
                question.className = 'question';

                const label = document.createElement('label');
                label.textContent = questionText;
                label.setAttribute('for', `${vitalSign.name}-${questionText}`);
                question.appendChild(label);

                const select = document.createElement('select');
                select.name = `${vitalSign.name}-${questionText}`;
                frequencyOptions.forEach(optionText => {
                    const option = document.createElement('option');
                    option.value = optionText;
                    option.textContent = optionText.charAt(0).toUpperCase() + optionText.slice(1);
                    select.appendChild(option);
                });
                question.appendChild(select);

                questionSet.appendChild(question);
            });

            part2Container.appendChild(questionSet);
        });

        const submitButton = document.getElementById('submitButton');
        submitButton.addEventListener('click', () => {
            const data = collectData();
            downloadCSV(data);
        });
    </script>
</body>
</html>
